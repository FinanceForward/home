<script type="module">
    import{Client,fql}from'https://cdn.jsdelivr.net/npm/fauna@latest/dist/browser/index.js';
    window.Client = Client;
    window.fql = fql;
    console.log(fql&&Client ? 'MODULE LOADED' : 'FAILED TO LOAD MODULE')
</script>
<script src="../fauna.js"></script>
<script>
function getCookie(cname) {
    let name = cname + "=";
    let decodedCookie = decodeURIComponent(document.cookie);
    let ca = decodedCookie.split(';');
    for(let i = 0; i <ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) == ' ') {
            c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
        }
    }
    return "";
}
</script>
<script>
async function sha256(message) {
  const msgBuffer = new TextEncoder().encode(message);
  const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  return hashHex;
}
let createUserHash = async (email, pass) => sha256(email+pass);

async function submit() {
    let titleOBJ = document.getElementById('title');
    let emailOBJ = document.getElementById('email');
    let passOBJ = document.getElementById('pass');
    let hash = getCookie('hash');
    if (!hash) {
        alert('You must be signed in to edit your account');
    }
    else if (await createUserHash(emailOBJ.value, passOBJ.value) != hash) {
        alert('Incorrect email or password');
    }
    else {
        titleOBJ.innerHTML = 'Enter New Email and Password';
        emailOBJ.placeholder = 'New Email';
        passOBJ.placeholder = 'New Password';
        passOBJ.type = 'password';
        passOBJ.value = '';
        passOBJ.type = 'text';
        passOBJ.value = '';
        let submitOBJ = document.getElementsByTagName('button')[0];
        submitOBJ.onclick = () => {
            let newEmail = emailOBJ.value;
            let newPass = passOBJ.value;
            let newHash = createUserHash(newEmail, newPass);
            DB.u.update(hash, {hash: newHash});
            document.cookie.split(";").forEach(function(c) { document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); });
            document.cookie = 'hash=' + newHash;
            alert('Account updated');
        }
    }
}
</script>
<h2 id="title">Enter Current Email and Password First</h2>
<input type="text" id="email" placeholder="Email">
<input type="password" id="pass" placeholder="Password">
<button onclick="submit()">Submit</button>